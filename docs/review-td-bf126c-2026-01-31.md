# Review Report — td-bf126c (2026-01-31)

## Scope
- Reviewed closed tasks in epic **td-bf126c** against `docs/sync-plan-03-merged.md` and `docs/sync-mvp-testing-spec.md`.
- Examined implementation in `internal/sync`, `internal/api`, `internal/serverdb`, `cmd/` + deployment assets.
- Referenced `docs/sync-testing-guide.md` gaps (noted as already tracked).

## Tests Run
```bash
go test ./...
```

## Fixes Applied (this review)
- **Sync event entity-type normalization** so `action_log` entries like `issue`, `handoff`, `board`, etc. map to canonical table names (`issues`, `handoffs`, `boards`, …) before push. This prevents pushes referencing non-existent tables.
- **Sync entity allowlist alignment**: added `work_sessions` and removed incorrect `board_issues` entry.
- Added test coverage for entity-type normalization + unsupported entity types being skipped.

Files changed:
- `internal/sync/client.go`
- `internal/sync/client_test.go`
- `cmd/sync.go`

## Findings vs Spec
### Major gaps (need follow-up work)
1. **Logs/comments/work sessions are not actually synced**
   - Spec and `docs/sync-client-guide.md` state these entities sync.
   - In code, `AddLog` and `AddComment` write directly to tables without action_log entries, so they never push.
   - Work sessions are also created without action_log entries.
   - This is a correctness gap for “fully functional” sync.

2. **Board positions / dependencies / file links have no sync strategy**
   - Action log emits `board_position`, `dependency`, `file_link` types but the sync engine assumes tables with a single `id` column.
   - Core tables like `board_issue_positions`, `issue_dependencies`, and `work_session_issues` use composite PKs and cannot be synced via the current engine.
   - Docs currently claim “board issues” sync, which is not true in implementation.

3. **Sync harness schema is not the real td schema**
   - `test/syncharness` uses a minimal hand-written schema instead of `internal/db` migrations.
   - This risks missing regressions in real schema (e.g., `board_issue_positions` rename, missing columns, non-id tables).

### Known test gaps (already tracked per `docs/sync-testing-guide.md`)
- Concurrency stress tests
- Crash-recovery (push succeeded but client didn’t mark synced)
- Rate limiting integration
- Large payloads near 10MB limit
- Long-session cursor drift
- HTTP-layer `exclude_client` coverage

## Tickets Created (epic: td-bf126c)
- **td-b55f9e** — Sync: log/comment/work_session changes not captured for sync
- **td-10f2bb** — Sync: board positions/dependencies/file links need a sync strategy
- **td-183738** — Sync harness should use real td schema/migrations

## Notes
- Server/API layer, sync engine, and serverdb schema are largely aligned with v3 spec.
- Device auth flow, project/membership APIs, and deployment assets look consistent with the Phase 1 tasks.
- The above gaps are the main blockers to “fully functional” sync as documented.
